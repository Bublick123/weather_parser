<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Weather Parser | –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Weather Parser</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/">–ì–ª–∞–≤–Ω–∞—è</a>
                <a class="nav-link active" aria-current="page" href="/results">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</a>
                <a class="nav-link" href="/monitor">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</a>
                <a class="nav-link" href="/forecast">–ü—Ä–æ–≥–Ω–æ–∑</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="d-flex align-items-center justify-content-between mb-4 flex-wrap gap-3">
            <div>
                <h4 class="mb-1">üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h4>
                <p class="text-muted small mb-0">–î–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</p>
            </div>
            <div class="d-flex gap-2">
                <input id="cityFilter" type="text" class="form-control" placeholder="üîç –§–∏–ª—å—Ç—Ä –ø–æ –≥–æ—Ä–æ–¥—É"
                    style="max-width: 220px;">
                <button class="btn btn-outline-primary" onclick="fetchResults()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
        </div>

        <div id="stats" class="mb-4"></div>

        <div id="resultsContainer" class="row g-4">
            <div class="col-12 text-center text-muted py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <p class="mt-3 mb-0">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
            </div>
        </div>
    </div>

    <script>
        let timerId;

        function getWeatherIcon(description) {
            const desc = (description || '').toLowerCase();
            if (desc.includes('—è—Å–Ω') || desc.includes('clear')) return '‚òÄÔ∏è';
            if (desc.includes('–æ–±–ª–∞—á') || desc.includes('cloud')) return '‚òÅÔ∏è';
            if (desc.includes('–¥–æ–∂–¥') || desc.includes('rain')) return 'üåßÔ∏è';
            if (desc.includes('—Å–Ω–µ–≥') || desc.includes('snow')) return '‚ùÑÔ∏è';
            if (desc.includes('—Ç—É–º–∞–Ω') || desc.includes('fog') || desc.includes('mist')) return 'üå´Ô∏è';
            if (desc.includes('–≥—Ä–æ–∑–∞') || desc.includes('thunder')) return '‚õàÔ∏è';
            return 'üå§Ô∏è';
        }

        function getTempColor(temp) {
            if (temp === null || temp === undefined) return '#718096';
            if (temp < 0) return '#4A90E2';      // –°–∏–Ω–∏–π - —Ö–æ–ª–æ–¥–Ω–æ
            if (temp < 10) return '#5B9BD5';     // –ì–æ–ª—É–±–æ–π - –ø—Ä–æ—Ö–ª–∞–¥–Ω–æ
            if (temp < 20) return '#70AD47';     // –ó–µ–ª—ë–Ω—ã–π - –Ω–æ—Ä–º–∞–ª—å–Ω–æ
            if (temp < 30) return '#FFC000';     // –ñ—ë–ª—Ç—ã–π - —Ç–µ–ø–ª–æ
            return '#FF6B6B';                     // –ö—Ä–∞—Å–Ω—ã–π - –∂–∞—Ä–∫–æ
        }

        function formatTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);

            if (diffMins < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (diffMins < 60) return `${diffMins} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours} —á –Ω–∞–∑–∞–¥`;
            return date.toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
        }

        function renderRows(items) {
            const container = document.getElementById('resultsContainer');
            if (!items.length) {
                container.innerHTML = `
            <div class="col-12">
                <div class="card text-center py-5">
                    <div class="card-body">
                        <h5 class="text-muted">üì≠ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h5>
                        <p class="text-muted mb-0">–î–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ –ø–æ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</p>
                    </div>
                </div>
            </div>
        `;
                return;
            }

            container.innerHTML = items.map(row => {
                const temp = row.temperature;
                const tempColor = getTempColor(temp);
                const icon = getWeatherIcon(row.description);
                const timeAgo = formatTime(row.created_at);

                return `
            <div class="col-md-6 col-lg-4">
                <div class="weather-card card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h5 class="card-title mb-1 fw-bold">${row.city}</h5>
                                <small class="text-muted">${timeAgo}</small>
                            </div>
                            <div class="weather-icon" style="font-size: 2.5rem;">${icon}</div>
                        </div>
                        
                        <div class="temperature-display mb-3" style="color: ${tempColor};">
                            <div class="d-flex align-items-baseline">
                                <span class="display-4 fw-bold">${temp !== null && temp !== undefined ? Math.round(temp) : '-'}</span>
                                <span class="fs-5 ms-2">¬∞C</span>
                            </div>
                        </div>
                        
                        <div class="weather-description mb-3">
                            <span class="badge bg-light text-dark px-3 py-2">${row.description || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</span>
                        </div>
                        
                        <div class="weather-details">
                            <div class="row g-2 small">
                                <div class="col-6">
                                    <div class="detail-item">
                                        <span class="text-muted">üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å:</span>
                                        <strong>${row.humidity !== null && row.humidity !== undefined ? row.humidity + '%' : '-'}</strong>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="detail-item">
                                        <span class="text-muted">üìä –î–∞–≤–ª–µ–Ω–∏–µ:</span>
                                        <strong>${row.pressure !== null && row.pressure !== undefined ? row.pressure + ' hPa' : '-'}</strong>
                                    </div>
                                </div>
                                ${row.wind_speed ? `
                                <div class="col-6">
                                    <div class="detail-item">
                                        <span class="text-muted">üí® –í–µ—Ç–µ—Ä:</span>
                                        <strong>${row.wind_speed} –º/—Å</strong>
                                    </div>
                                </div>
                                ` : ''}
                                ${row.clouds !== null && row.clouds !== undefined ? `
                                <div class="col-6">
                                    <div class="detail-item">
                                        <span class="text-muted">‚òÅÔ∏è –û–±–ª–∞—á–Ω–æ—Å—Ç—å:</span>
                                        <strong>${row.clouds}%</strong>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
            }).join('');
        }

        async function fetchResults() {
            const city = document.getElementById('cityFilter').value.trim();
            const qs = city ? `?city=${encodeURIComponent(city)}` : '';
            try {
                const resp = await fetch(`/api/results${qs}`);
                const data = await resp.json();
                renderRows(data.items || []);
                document.getElementById('stats').innerHTML =
                    `<strong>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong> –û—Ç–æ–±—Ä–∞–∂–µ–Ω–æ: <strong>${data.count}</strong> | –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: <strong>${data.total_records}</strong> | –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤: <strong>${data.unique_cities}</strong>`;
            } catch (err) {
                renderRows([]);
                document.getElementById('stats').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
            }
        }

        function startAutoRefresh() {
            if (timerId) clearInterval(timerId);
            timerId = setInterval(fetchResults, 10000);
        }

        document.getElementById('cityFilter').addEventListener('input', () => {
            fetchResults();
        });

        fetchResults();
        startAutoRefresh();
    </script>
</body>

</html>